# Debug工具 - 系统化调查与专家分析

**逐步调查后的专家调试协助**

`debug`工作流指导Claude通过系统化调查过程，Claude执行有条理的代码检查、证据收集和跨多个步骤的假设形成。一旦调查完成，该工具基于所有收集的发现（可选地）从选定的AI模型提供专家分析。

## 示例提示

```
让gemini调试为什么我的API随机返回400错误，附带完整堆栈跟踪：[粘贴回溯]
```

您也可以要求它自己调试，不需要外部模型（**在大多数情况下推荐**）。
```
使用debug工具找出应用程序为什么崩溃，这里有一些应用日志[粘贴应用日志]和崩溃跟踪：[粘贴崩溃跟踪]
```

## 如何工作

debug工具实现了**系统化调查方法**，Claude被指导通过结构化调试步骤：

**调查阶段：**
1. **步骤1**：Claude描述问题并开始深入思考可能的根本原因、副作用和促成因素
2. **步骤2+**：Claude检查相关代码、跟踪错误、测试假设并收集证据
3. **整个过程**：Claude跟踪发现、相关文件、方法和发展中的假设及置信度
4. **回溯**：当新见解出现时，Claude可以修改之前的步骤
5. **完成**：一旦调查彻底，Claude发出完成信号

**专家分析阶段：**
在Claude完成调查后，它自动调用选定的AI模型（除非置信度为**certain**，在这种情况下专家分析被绕过）：
- 包含所有步骤和发现的完整调查摘要
- 调查期间识别的相关文件和方法
- 最终假设和置信度评估
- 错误上下文和支持证据
- 提供的视觉调试材料

这种结构化方法确保Claude在专家分析之前执行有条理的基础工作，导致显著更好的调试结果和更高效的token使用。

**特别说明**：如果您希望Claude执行整个调试调查而不调用其他模型，可以在提示中包含"不使用任何其他模型"，Claude将独立完成完整工作流。

## 关键功能

- **多步调查过程**，包括证据收集和假设演化
- **系统化代码检查**，在整个调查过程中跟踪文件和方法
- **置信度评估和修订**能力用于调查步骤
- **回溯支持**，当新见解出现时修改之前的步骤
- **专家分析集成**，基于完整调查提供最终调试建议
- **错误上下文支持**：堆栈跟踪、日志和运行时信息
- **视觉调试**：包含错误屏幕截图、堆栈跟踪、控制台输出
- **对话线程**：跨多个会话继续调查
- **大上下文分析**：处理广泛的日志文件和多个相关代码文件
- **多语言支持**：调试Python、JavaScript、Java、C#、Swift等问题
- **网络搜索集成**：识别何时额外研究有助于解决问题

## 工具参数

**调查步骤参数：**
- `step`：当前调查步骤描述（必需）
- `step_number`：调查序列中的当前步骤号（必需）
- `total_steps`：估计的总调查步骤数（随过程发展可调整）
- `next_step_required`：是否需要另一个调查步骤
- `findings`：在此步骤中收集的发现和证据（必需）
- `files_checked`：调查期间检查的所有文件（跟踪探索路径）
- `relevant_files`：与根本原因或其影响直接相关的文件
- `relevant_methods`：涉及问题的具体方法/函数
- `hypothesis`：关于根本原因的当前最佳猜测
- `confidence`：对当前假设的置信度（exploring/low/medium/high/certain）
- `backtrack_from_step`：要回溯的步骤号（用于修订）
- `continuation_id`：跨会话继续调查的线程ID
- `images`：视觉调试材料（错误屏幕截图、日志等）

**模型选择：**
- `model`：auto|pro|flash|flash-2.0|flashlite|o3|o3-mini|o4-mini|gpt4.1|gpt5|gpt5-mini|gpt5-nano（默认：服务器默认）
- `thinking_mode`：minimal|low|medium|high|max（默认：medium，仅Gemini）
- `use_websearch`：启用文档和解决方案的网络搜索（默认：true）
- `use_assistant_model`：是否使用专家分析阶段（默认：true，设置为false仅使用Claude）

## 使用示例

**错误调试：**
```
调试这个TypeError：'NoneType'对象在我的parser.py中没有'split'属性
```

**带堆栈跟踪：**
```
使用gemini调试为什么我的API返回500错误，附带此堆栈跟踪：[粘贴完整回溯]
```

**带文件上下文：**
```
不使用外部模型调试auth.py和user_model.py中的认证失败
```

**性能调试：**
```
不使用外部模型调试以找出应用程序在批量编辑操作期间为什么消耗过多内存
```

**运行时环境问题：**
```
调试服务器启动失败的部署问题，这里是运行时信息：[环境详细信息]
```

## 调查方法

debug工具强制执行彻底、结构化的调查过程：

**逐步调查（Claude主导）：**
1. **初始问题描述：** Claude描述问题并开始思考可能的原因、副作用和促成因素
2. **代码检查：** Claude系统地检查相关文件、跟踪执行路径并识别可疑模式
3. **证据收集：** Claude收集发现、跟踪检查的文件并识别涉及的方法/函数
4. **假设形成：** Claude制定关于根本原因的工作理论及置信度评估
5. **迭代完善：** 随着理解的发展，Claude可以回溯并修改之前的步骤
6. **调查完成：** 当收集到足够证据时，Claude发出信号

**专家分析阶段（使用时的另一个AI模型）：**
一旦调查完成，选定的AI模型执行：
- **根本原因分析：** 对所有调查发现和证据的深度分析
- **解决方案建议：** 具有实施指导的具体修复
- **预防策略：** 避免类似问题的措施
- **测试方法：** 建议解决方案的验证方法

**关键优势：**
- **有条理的证据收集：** 确保不遗漏关键信息
- **渐进理解：** 随着调查深入，假设不断发展
- **完整上下文：** 专家分析接收完整的调查历史
- **高效Token使用：** 结构化方法防止冗余的来回交流

## 调试类别

**运行时错误：**
- 异常和崩溃
- 空指针/引用错误
- 类型错误和转换问题
- 内存泄漏和资源耗尽

**逻辑错误：**
- 不正确的算法实现
- 逐一错误和边界条件
- 状态管理问题
- 竞态条件和并发错误

**集成问题：**
- API通信失败
- 数据库连接问题
- 第三方服务集成
- 配置和环境问题

**性能问题：**
- 响应时间慢
- 内存使用峰值
- CPU密集型操作
- I/O瓶颈

## 最佳实践

**对于调查步骤：**
- **在步骤描述中要彻底**：解释您在检查什么以及为什么
- **跟踪所有检查的文件**：包括不包含错误的文件（跟踪调查路径）
- **清楚记录发现**：总结发现、可疑模式和证据
- **发展假设**：随着调查进展更新理论
- **明智使用回溯**：当新见解出现时修改之前的步骤
- **包含视觉证据**：屏幕截图、错误对话框、控制台输出

**对于初始问题描述：**
- **提供完整的错误上下文**：完整的堆栈跟踪、错误消息和日志
- **描述预期与实际行为**：清楚的症状描述
- **包含环境详细信息**：运行时版本、配置、部署上下文
- **提及之前的尝试**：已经尝试的调试步骤
- **具体说明发生情况**：何时、何地以及如何表现问题

## 高级功能

**大型日志分析：**
使用像Gemini Pro（1M上下文）这样的模型，您可以包含广泛的日志文件进行全面分析：
```
"使用这些大型日志文件调试应用程序崩溃：app.log、error.log、system.log"
```

**多文件调查：**
同时分析多个相关文件以了解复杂问题：
```
"调试跨processor.py、validator.py和output_handler.py的数据处理管道问题"
```

**网络搜索集成：**
该工具可以推荐对错误消息、已知问题或文档的具体搜索：
```
分析后："Claude推荐搜索：'Django 4.2 migration error specific_error_code'、'PostgreSQL connection pool exhaustion solutions'"
```

## 何时使用Debug与其他工具

- **使用`debug`**：需要系统调查的特定运行时错误、异常、崩溃、性能问题
- **使用`codereview`**：在没有特定错误或症状的情况下在代码中找到潜在错误
- **使用`analyze`**：理解代码结构和流程而不是排除特定问题
- **使用`precommit`**：在提交前验证更改以防止引入错误

## 调查示例

**步骤1：** "用户认证间歇性失败，没有错误日志。我需要调查认证流程并识别可能发生静默失败的地方。"

**步骤2：** "检查了auth.py并发现三个潜在失败点：token验证、数据库连接和会话管理。还没有明显的错误，但需要跟踪执行流程。"

**步骤3：** "在session_manager.py第45-67行发现可疑的async/await模式。await可能缺少异常处理。这可能解释静默失败。"

**完成：** 调查揭示异常处理中可能的根本原因，准备用完整上下文进行专家分析。
